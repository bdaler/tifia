
### Установка и запуск:
* ```docker-compose up -d```

### Список команд:
* ```php yii refs-tree --clientUid=82824897``` - Команда для вывода дерево рефералов
* ```php yii profit --clientUid=82824897 --startDate="2018-11-24 14:52:24" --endDate="2018-11-24 14:52:24"``` - Команда для подсчета прибыльности (сумма `profit`).
* ```php yii summary-profit --clientUid=82824897 --startDate="2018-11-24 14:52:24" --endDate="2018-11-24 14:52:24"``` - Команда для подсчета суммарного объема. 
* ```php yii referrals --clientUid=82824897 --directRefs=false|true``` - Команда для подсчета количество прямых рефералов и количество всех рефералов клиента, параметры: ```directRefs=true``` - прямые рефералы.
* ```php yii referrals/ref-levels --clientUid=82824897``` - Команда для подсчета количество уровней реферальной сетки.

### БД
* Проанализировать базу данных, указать узкие места:
    * Отсутствует ```FOREIGN_KEY``` в связанных таблицах.
    * Отсутствует индексы, как минимум на поле ```client_uid``` во всех трех таблицах. 

# Тестовое задание для Tifia.com
 
 ### Вводная информация
 В нашем сервисе клиенты представлены в таблице `Users`. Каждый клиент может открыть до 12 счетов. Счета хранятся в таблице `Accounts`, каждый счёт связан с определенным клиентом. На любом из счетов может быть торговля. Торговые операции представлены в таблице `Trades`.
 
 Очень часто нам приходится строить дерево партнера, опираясь на поле `partner_id` в таблице `Users`. Под партнерским деревом понимается структура, в вершине которой находится заданный клиент. Под ним находятся другие клиенты, у которых `User2[partner_id] = User1[client_uid]`, у `User2` могут быть еще рефералы (те, у кого в `partner_id` стоит `User2[client_uid]`). Если `partner_id = 0`, это означает, что клиент не входит ни в чью реферальную сетку, но может быть корнем своей сети.
 
 ### Задачи
* Проанализировать базу данных, указать узкие места.
* Построить дерево рефералов на основе поля `partner_id` таблицы `Users`
* Написать скрипт, способный обсчитать реферальную сетку партнера по следующим критериям:
	* посчитать суммарный объем `volume * coeff_h * coeff_cr` по всем уровням реферральной системы за период времени
	* посчитать прибыльность (сумма `profit`) за определенный период времени
	* посчитать количество прямых рефералов и количество всех рефералов клиента
		* [под прямыми рефералами понимаются те, у кого в `partner_id` стоит `client_uid` клиента]
		* [под всеми рефералами понимается совокупность всех прямых рефералов, их прямых рефералов и т.д. до клиентов, под которыми нет рефералов]
	* посчитать количество уровней реферальной сетки
	* при выполнении задания _нужно использовать_ фреймворк Yii2

Примечание: период времени определяет интервал поля `close_time` таблицы `Trades`

**Для удобства**, можно обсчитать клиента с `client_uid = 82824897`

###### Пример построения дерева
| id  | client_uid  | partner_id  |
| :------------: | :------------: | :------------: |
|  1 | 123 | 0  |
|  2 | 456 | 0  |
|  3 | 312 | 0  |
|  4 | 471 | 123  |
|  5 | 965 | 123  |
|  6 | 892 | 965  |
|  7 | 111 | 456  |
|  8 | 222 | 111  |
|  9 | 333 | 111  |

По данному набору клиентов можно построить следующую реферальную сеть:
```bash
├── 123
│     ├── 471
│     ├── 965
│            ├── 892
├── 456
│     ├── 111
│            ├── 222
│            ├── 333
├── 312
```
У клиента с `client_uid = 123` - 2 уровня реферальной сети.

У клиента с `client_uid = 965` - 1 уровень реферально сети.

### Таблицы
- Users
- Accounts
- Trades

###### Users
|  id  | client_uid | email  | gender  | fullname  | country  | region | city | address | partner_id  | reg_date  | status  |
| :------------: | :------------: | :------------: | :------------: | :------------: | :------------: | :------------: | :------------: | :------------: | :------------: | :------------: | :------------: |
| int  | int | string  | string | string  | string(2)  | string | string | string | int  | datetime  | int  |

###### Accounts
| client_uid  | login  |
| :------------: | :------------: |
| string  | string  |

###### Trades
| id | ticket  | login  | symbol  | cmd  | volume  | open_time  | close_time |  profit  | coeff_h  | coeff_cr  |
| :------------: | :------------: | :------------: | :------------: | :------------: | :------------: | :------------: | :------------: | :------------: | :------------: | :------------: |
| int | int  | int  | string  | int(1)  | float  | datetime  | datetime  | float  | float  | float  |

### Доступ к БД
```
host : 142.91.155.196
dbname : <выдаем>
username: tester
password: Jwsq5YwG0aFcJtaK2xdo

```

Примечание: Не разрешается добавлять новые столбцы и таблицы. Тестовую базу данных можно улучшать.